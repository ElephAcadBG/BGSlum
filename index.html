<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Bengaluru Interactive Map</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <style>
    body { margin: 0; padding: 0; }
    #map { position: absolute; top: 0; bottom: 0; width: 100%; }

    .legend, .controls, .layers {
      background: white;
      padding: 10px;
      font-size: 12px;
      border-radius: 4px;
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
    }

    .legend {
      position: absolute;
      bottom: 30px;
      left: 10px;
    }

    .controls {
      position: absolute;
      top: 10px;
      left: 10px;
    }

    .layers {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 170px;
    }

    .legend div, .layers label {
      display: flex;
      align-items: center;
      margin-bottom: 4px;
    }

    .legend span {
      display: inline-block;
      width: 16px;
      height: 10px;
      margin-right: 6px;
    }

    .icon {
      background-image: url('https://cdn-icons-png.flaticon.com/512/684/684908.png');
      background-size: cover;
      width: 30px;
      height: 30px;
      border-radius: 50%;
    }
  </style>
</head>
<body>
<div id="map"></div>

<!-- Legend -->
<div class="legend">
  <strong>Legend</strong>
  <div><span style="background:#28a745;"></span>Low Traffic</div>
  <div><span style="background:#ffc107;"></span>Moderate Traffic</div>
  <div><span style="background:#fd7e14;"></span>Heavy Traffic</div>
  <div><span style="background:#dc3545;"></span>Severe Traffic</div>
  <div><span style="background:#800080;"></span>Slum Area</div>
  <div><span style="background:#6f42c1;"></span>Inner Ring Road</div>
  <div><span style="background:#17a2b8;"></span>Outer Ring Road</div>
  <div><span style="background:#ff69b4;"></span>Proposed Ring Roads</div>
</div>

<!-- Traffic Time Buttons -->
<div class="controls">
  <strong>View Traffic:</strong><br>
  <button onclick="simulateTraffic('9am')">9 AM Weekday</button>
  <button onclick="simulateTraffic('5pm')">5 PM Weekday</button>
  <button onclick="loadTrafficLayer()">Live Now</button>
</div>

<!-- Layer Toggles -->
<div class="layers">
  <strong>Toggle Layers:</strong><br>
  <label><input type="checkbox" checked onchange="toggleLayer('techParks')"> Tech Parks</label>
  <label><input type="checkbox" checked onchange="toggleLayer('traffic')"> Traffic</label>
  <label><input type="checkbox" checked onchange="toggleLayer('slums-layer')"> Slum Areas</label>
  <label><input type="checkbox" checked onchange="toggleLayer('inner-ring-layer')"> Inner Ring Road</label>
  <label><input type="checkbox" checked onchange="toggleLayer('outer-ring-layer')"> Outer Ring Road</label>
  <label><input type="checkbox" checked onchange="toggleLayer('proposed-rings-layer')"> Proposed Rings</label>
</div>

<script>
  mapboxgl.accessToken = 'pk.eyJ1IjoiZXNoYTIiLCJhIjoiY2x3cTBoMm00MXU1czJpcGh3dG1rM3pwOCJ9.ikbt6TWq22WnDuNiFwxVjA';

  const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/streets-v11',
    center: [77.5946, 12.9716],
    zoom: 11
  });

  const techParks = [
    { name: "Manyata Tech Park", coords: [77.6250, 13.0534], address: "Nagawara" },
    { name: "Bagmane Tech Park", coords: [77.6596, 12.9786], address: "C V Raman Nagar" },
    { name: "RMZ Infinity", coords: [77.6610, 12.9908], address: "Old Madras Road" },
    { name: "EcoSpace", coords: [77.6842, 12.9187], address: "Bellandur" },
    { name: "Embassy TechVillage", coords: [77.6936, 12.9285], address: "Outer Ring Road" },
    { name: "Global Village", coords: [77.4983, 12.9136], address: "Rajarajeshwari Nagar" },
    { name: "RMZ Ecoworld", coords: [77.6874, 12.9214], address: "ORR" },
    { name: "Prestige Tech Park", coords: [77.6973, 12.9366], address: "Marathahalli-Sarjapur ORR" },
    { name: "Pritech Park SEZ", coords: [77.7010, 12.9273], address: "Bellandur" }
  ];

  const techParkMarkers = [];

  function addTechParkMarkers() {
    techParks.forEach(park => {
      const marker = new mapboxgl.Marker({ element: createCustomIcon(), anchor: 'bottom' })
        .setLngLat(park.coords)
        .setPopup(new mapboxgl.Popup().setHTML(`<strong>${park.name}</strong><br>${park.address}`))
        .addTo(map);
      techParkMarkers.push(marker);
    });
  }

  function createCustomIcon() {
    const icon = document.createElement('div');
    icon.className = 'icon';
    return icon;
  }

  function loadTrafficLayer() {
    if (!map.getSource('traffic')) {
      map.addSource('traffic', {
        type: 'vector',
        url: 'mapbox://mapbox.mapbox-traffic-v1'
      });

      map.addLayer({
        id: 'traffic',
        type: 'line',
        source: 'traffic',
        'source-layer': 'traffic',
        layout: { 'line-cap': 'round', 'line-join': 'round' },
        paint: {
          'line-color': [
            'match',
            ['get', 'congestion'],
            'low', '#28a745',
            'moderate', '#ffc107',
            'heavy', '#fd7e14',
            'severe', '#dc3545',
            '#999999'
          ],
          'line-width': ['interpolate', ['linear'], ['zoom'], 5, 1, 14, 4]
        }
      });
    }
  }

  function simulateTraffic(time) {
    if (!map.getSource('traffic')) return;
    const colorMap = time === '9am'
      ? { low: '#ffc107', moderate: '#fd7e14', heavy: '#dc3545', severe: '#dc3545' }
      : { low: '#28a745', moderate: '#ffc107', heavy: '#fd7e14', severe: '#dc3545' };

    map.setPaintProperty('traffic', 'line-color', [
      'match',
      ['get', 'congestion'],
      'low', colorMap.low,
      'moderate', colorMap.moderate,
      'heavy', colorMap.heavy,
      'severe', colorMap.severe,
      '#999999'
    ]);
  }

  function toggleLayer(layerId) {
    const checkbox = document.querySelector(`input[type="checkbox"][onchange*="'${layerId}'"]`);
    const show = checkbox.checked;

    if (layerId === 'techParks') {
      techParkMarkers.forEach(marker => {
        const el = marker.getElement();
        el.style.display = show ? 'block' : 'none';
      });
      return;
    }

    if (!map.getLayer(layerId)) return;
    map.setLayoutProperty(layerId, 'visibility', show ? 'visible' : 'none');
  }

  map.on('load', () => {
    loadTrafficLayer();
    addTechParkMarkers();

    fetch('https://raw.githubusercontent.com/ElephAcadBG/BGSlum/main/bangalore-slum3.geojson')
      .then(res => res.json())
      .then(data => {
        map.addSource('slums', { type: 'geojson', data: data });
        map.addLayer({
          id: 'slums-layer',
          type: 'fill',
          source: 'slums',
          paint: {
            'fill-color': '#800080',
            'fill-opacity': 0.4,
            'fill-outline-color': '#4b004b'
          }
        });
      });

    fetch('https://raw.githubusercontent.com/ElephAcadBG/BGSlum/main/innerring.geojson')
      .then(res => res.json())
      .then(data => {
        map.addSource('inner-ring', { type: 'geojson', data: data });
        map.addLayer({
          id: 'inner-ring-layer',
          type: 'line',
          source: 'inner-ring',
          paint: {
            'line-color': '#6f42c1',
            'line-width': 3
          }
        });
      });

    fetch('https://raw.githubusercontent.com/ElephAcadBG/BGSlum/main/outerring.geojson')
      .then(res => res.json())
      .then(data => {
        map.addSource('outer-ring', { type: 'geojson', data: data });
        map.addLayer({
          id: 'outer-ring-layer',
          type: 'line',
          source: 'outer-ring',
          paint: {
            'line-color': '#17a2b8',
            'line-width': 3
          }
        });
      });

    fetch('https://raw.githubusercontent.com/ElephAcadBG/BGSlum/main/proposedrings.geojson')
      .then(res => res.json())
      .then(data => {
        map.addSource('proposed-rings', { type: 'geojson', data: data });
        map.addLayer({
          id: 'proposed-rings-layer',
          type: 'line',
          source: 'proposed-rings',
          paint: {
            'line-color': '#ff69b4',
            'line-width': 2,
            'line-dasharray': [2, 2]
          }
        });
      });
  });

  setInterval(() => {
    loadTrafficLayer();
  }, 5 * 60 * 1000);
</script>
</body>
</html>
